apiVersion: batch/v1
kind: Job
metadata:
  name: llm-copy-job
  namespace: default
spec:
  template:
    spec:
      nodeName: worker-0  # Sp√©cifier le n≈ìud cible
      initContainers:
      - name: llm-download
        image: registry.redhat.io/ubi8/ubi:latest
        command: ["/bin/bash"]
        args:
        - -c
        - |
          echo "üì• T√©l√©chargement du LLM..."
          
          # Installer les outils n√©cessaires
          dnf install -y wget git-lfs tar gzip
          
          # Cr√©er le r√©pertoire de destination
          mkdir -p /opt/llm/models
          cd /opt/llm/models
          
          # M√©thode 1: Depuis Hugging Face (n√©cessite un token)
          # export HF_TOKEN="your_token_here"
          # git lfs install
          # git clone https://huggingface.co/meta-llama/Llama-2-7b-chat-hf
          
          # M√©thode 2: Depuis un serveur S3/MinIO
          # dnf install -y aws-cli
          # aws s3 cp s3://my-bucket/llama2-7b.tar.gz .
          # tar -xzf llama2-7b.tar.gz
          
          # M√©thode 3: Depuis un serveur HTTP
          wget -O llama2-7b.tar.gz "https://example.com/models/llama2-7b.tar.gz"
          tar -xzf llama2-7b.tar.gz
          rm llama2-7b.tar.gz
          
          echo "‚úÖ LLM t√©l√©charg√© et extrait"
        volumeMounts:
        - name: llm-storage
          mountPath: /opt/llm
      containers:
      - name: llm-copy
        image: registry.redhat.io/ubi8/ubi:latest
        command: ["/bin/bash"]
        args:
        - -c
        - |
          echo "üîÑ Copie du LLM vers le syst√®me de fichiers du n≈ìud..."
          
          # Copier vers le syst√®me de fichiers du n≈ìud
          cp -r /opt/llm/* /host/opt/llm/
          chmod -R 755 /host/opt/llm
          
          echo "‚úÖ LLM copi√© vers le n≈ìud"
          
          # V√©rifier l'espace disque
          df -h /host/opt/llm
          
          echo "üéâ Op√©ration termin√©e"
        volumeMounts:
        - name: llm-storage
          mountPath: /opt/llm
        - name: host-storage
          mountPath: /host
          readOnly: false
      volumes:
      - name: llm-storage
        emptyDir: {}
      - name: host-storage
        hostPath:
          path: /
          type: Directory
      restartPolicy: Never
  backoffLimit: 3 