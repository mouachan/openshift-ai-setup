# Makefile pour la dÃ©mo Triton Inference
.PHONY: help setup install-deps run-pipeline run-notebook deploy undeploy test status logs clean

# Variables
PYTHON = python3
VENV = venv
NAMESPACE = rhods-notebooks
MODEL_NAME = iris-classifier-triton

# Couleurs pour l'affichage
BLUE = \033[0;34m
GREEN = \033[0;32m
YELLOW = \033[1;33m
RED = \033[0;31m
NC = \033[0m # No Color

help: ## Affiche cette aide
	@echo "$(BLUE)DÃ©mo Triton Inference - Commandes disponibles:$(NC)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(YELLOW)%-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(BLUE)Exemples d'utilisation:$(NC)"
	@echo "  make setup             # Configuration de l'environnement"
	@echo "  make run-pipeline      # ExÃ©cution du pipeline ML"
	@echo "  make deploy-model      # DÃ©ploiement du modÃ¨le"
	@echo "  make test              # Test d'infÃ©rence"
	@echo "  make demo-local        # DÃ©mo locale complÃ¨te"

setup-complete: ## Configuration GitOps complÃ¨te de l'environnement (OBSOLÃˆTE)
	@echo "$(YELLOW)âš ï¸  Cette commande est obsolÃ¨te$(NC)"
	@echo "$(BLUE)Le GitOps est maintenant intÃ©grÃ© dans le GitOps principal$(NC)"
	@echo "$(BLUE)Utilisez: oc apply -f ../../argocd-apps/openshift-ai-application.yaml$(NC)"

deploy-gitops: ## DÃ©ploiement GitOps du Data Science Project (OBSOLÃˆTE)
	@echo "$(YELLOW)âš ï¸  Cette commande est obsolÃ¨te$(NC)"
	@echo "$(BLUE)Le GitOps est maintenant intÃ©grÃ© dans le GitOps principal$(NC)"

deploy-gitops-complete: ## DÃ©ploiement GitOps complet en une fois (OBSOLÃˆTE)
	@echo "$(YELLOW)âš ï¸  Cette commande est obsolÃ¨te$(NC)"
	@echo "$(BLUE)Le GitOps est maintenant intÃ©grÃ© dans le GitOps principal$(NC)"

undeploy-gitops: ## Suppression du dÃ©ploiement GitOps (OBSOLÃˆTE)
	@echo "$(YELLOW)âš ï¸  Cette commande est obsolÃ¨te$(NC)"
	@echo "$(BLUE)Le GitOps est maintenant intÃ©grÃ© dans le GitOps principal$(NC)"

status-gitops: ## Statut du dÃ©ploiement GitOps (OBSOLÃˆTE)
	@echo "$(YELLOW)âš ï¸  Cette commande est obsolÃ¨te$(NC)"
	@echo "$(BLUE)Utilisez: oc get all -n triton-demo$(NC)"

configure-elyra: ## Configuration d'Elyra pour les pipelines
	@echo "$(BLUE)ğŸ”§ Configuration Elyra...$(NC)"
	$(PYTHON) scripts/configure_elyra.py configure
	@echo "$(GREEN)âœ… Elyra configurÃ©$(NC)"

verify-elyra: ## VÃ©rification de la configuration Elyra
	@echo "$(BLUE)ğŸ” VÃ©rification Elyra...$(NC)"
	$(PYTHON) scripts/configure_elyra.py verify

validate-gitops: ## Validation complÃ¨te de la configuration GitOps (OBSOLÃˆTE)
	@echo "$(YELLOW)âš ï¸  Cette commande est obsolÃ¨te$(NC)"
	@echo "$(BLUE)Le GitOps est maintenant intÃ©grÃ© dans le GitOps principal$(NC)"

validate-quick: ## Validation rapide de la configuration (OBSOLÃˆTE)
	@echo "$(YELLOW)âš ï¸  Cette commande est obsolÃ¨te$(NC)"
	@echo "$(BLUE)Le GitOps est maintenant intÃ©grÃ© dans le GitOps principal$(NC)"

setup: ## Configuration complÃ¨te de l'environnement
	@echo "$(BLUE)ğŸ”§ Configuration de l'environnement...$(NC)"
	./scripts/setup.sh venv
	@echo "$(GREEN)âœ… Configuration terminÃ©e$(NC)"
	@echo "$(YELLOW)Prochaine Ã©tape: make run-pipeline$(NC)"

install-deps: ## Installation des dÃ©pendances Python
	@echo "$(BLUE)ğŸ“¦ Installation des dÃ©pendances...$(NC)"
	$(PYTHON) -m pip install --upgrade pip
	$(PYTHON) -m pip install -r requirements.txt
	@echo "$(GREEN)âœ… DÃ©pendances installÃ©es$(NC)"

venv: ## CrÃ©ation de l'environnement virtuel
	@echo "$(BLUE)ğŸ CrÃ©ation de l'environnement virtuel...$(NC)"
	$(PYTHON) -m venv $(VENV)
	@echo "$(GREEN)âœ… Environnement virtuel crÃ©Ã©$(NC)"
	@echo "$(YELLOW)Activez-le avec: source $(VENV)/bin/activate$(NC)"

run-pipeline: ## ExÃ©cution du pipeline Kubeflow complet
	@echo "$(BLUE)ğŸš€ Lancement du pipeline Kubeflow...$(NC)"
	$(PYTHON) pipelines/iris_classification_pipeline.py
	@echo "$(GREEN)âœ… Pipeline terminÃ©$(NC)"

run-notebook: ## Lancement de Jupyter Notebook
	@echo "$(BLUE)ğŸ““ Lancement de Jupyter Notebook...$(NC)"
	jupyter notebook notebooks/
	@echo "$(GREEN)âœ… Notebook fermÃ©$(NC)"

preprocess: ## ExÃ©cution de la prÃ©paration des donnÃ©es
	@echo "$(BLUE)ğŸ“Š PrÃ©paration des donnÃ©es...$(NC)"
	$(PYTHON) pipelines/data_preprocessing.py
	@echo "$(GREEN)âœ… DonnÃ©es prÃ©parÃ©es$(NC)"

train: ## ExÃ©cution de l'entraÃ®nement du modÃ¨le
	@echo "$(BLUE)ğŸ¤– EntraÃ®nement du modÃ¨le...$(NC)"
	$(PYTHON) pipelines/model_training.py
	@echo "$(GREEN)âœ… ModÃ¨le entraÃ®nÃ©$(NC)"

register: ## Enregistrement du modÃ¨le dans Model Registry
	@echo "$(BLUE)ğŸ“‹ Enregistrement du modÃ¨le...$(NC)"
	$(PYTHON) pipelines/model_registry.py
	@echo "$(GREEN)âœ… ModÃ¨le enregistrÃ©$(NC)"

deploy: deploy-model ## DÃ©ploiement du modÃ¨le avec Triton (legacy)

deploy-model: ## DÃ©ploiement du modÃ¨le avec Triton (OBSOLÃˆTE)
	@echo "$(YELLOW)âš ï¸  Cette commande est obsolÃ¨te$(NC)"
	@echo "$(BLUE)Le dÃ©ploiement se fait maintenant via le GitOps intÃ©grÃ©$(NC)"
	@echo "$(BLUE)Utilisez: oc apply -k ../../components/instances/triton-demo-instance/base/model-serving/$(NC)"

undeploy: undeploy-model ## Suppression du dÃ©ploiement (legacy)

undeploy-model: ## Suppression du dÃ©ploiement du modÃ¨le (OBSOLÃˆTE)
	@echo "$(YELLOW)âš ï¸  Cette commande est obsolÃ¨te$(NC)"
	@echo "$(BLUE)Le dÃ©ploiement se fait maintenant via le GitOps intÃ©grÃ©$(NC)"

status: ## Affichage du statut du dÃ©ploiement (OBSOLÃˆTE)
	@echo "$(YELLOW)âš ï¸  Cette commande est obsolÃ¨te$(NC)"
	@echo "$(BLUE)Utilisez: oc get all -n triton-demo$(NC)"

logs: ## Affichage des logs du dÃ©ploiement (OBSOLÃˆTE)
	@echo "$(YELLOW)âš ï¸  Cette commande est obsolÃ¨te$(NC)"
	@echo "$(BLUE)Utilisez: oc logs -l app.kubernetes.io/name=triton-demo -n triton-demo$(NC)"

test: ## Test d'infÃ©rence du modÃ¨le dÃ©ployÃ©
	@echo "$(BLUE)ğŸ§ª Test d'infÃ©rence...$(NC)"
	./scripts/test_inference.py

test-local: ## Test local des scripts Python
	@echo "$(BLUE)ğŸ§ª Test local des scripts...$(NC)"
	$(PYTHON) -c "import kfp, sklearn, tensorflow; print('âœ… DÃ©pendances OK')"
	$(PYTHON) -c "from pipelines.data_preprocessing import load_and_preprocess_data; print('âœ… Script prÃ©processing OK')"
	$(PYTHON) -c "from pipelines.model_training import train_model; print('âœ… Script training OK')"
	@echo "$(GREEN)âœ… Tests locaux rÃ©ussis$(NC)"

clean: ## Nettoyage des fichiers temporaires
	@echo "$(BLUE)ğŸ§¹ Nettoyage...$(NC)"
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	rm -rf .pytest_cache/
	rm -rf models/temp/
	@echo "$(GREEN)âœ… Nettoyage terminÃ©$(NC)"

clean-venv: ## Suppression de l'environnement virtuel
	@echo "$(BLUE)ğŸ—‘ï¸  Suppression de l'environnement virtuel...$(NC)"
	rm -rf $(VENV)
	@echo "$(GREEN)âœ… Environnement virtuel supprimÃ©$(NC)"

check-cluster: ## VÃ©rification de la connexion au cluster
	@echo "$(BLUE)ğŸ” VÃ©rification de la connexion au cluster...$(NC)"
	@oc whoami >/dev/null && echo "$(GREEN)âœ… ConnectÃ© en tant que: $$(oc whoami)$(NC)" || echo "$(RED)âŒ Non connectÃ© au cluster$(NC)"
	@oc get namespace $(NAMESPACE) >/dev/null 2>&1 && echo "$(GREEN)âœ… Namespace $(NAMESPACE) disponible$(NC)" || echo "$(RED)âŒ Namespace $(NAMESPACE) non trouvÃ©$(NC)"

check-prerequisites: ## VÃ©rification des prÃ©requis
	@echo "$(BLUE)ğŸ” VÃ©rification des prÃ©requis...$(NC)"
	@command -v $(PYTHON) >/dev/null && echo "$(GREEN)âœ… Python3 disponible$(NC)" || echo "$(RED)âŒ Python3 non trouvÃ©$(NC)"
	@command -v oc >/dev/null && echo "$(GREEN)âœ… OpenShift CLI disponible$(NC)" || echo "$(RED)âŒ OpenShift CLI non trouvÃ©$(NC)"
	@command -v jupyter >/dev/null && echo "$(GREEN)âœ… Jupyter disponible$(NC)" || echo "$(YELLOW)âš ï¸  Jupyter non trouvÃ© (installez avec: pip install jupyter)$(NC)"
	@command -v curl >/dev/null && echo "$(GREEN)âœ… curl disponible$(NC)" || echo "$(YELLOW)âš ï¸  curl non trouvÃ©$(NC)"

check-gitops: ## VÃ©rification du statut du GitOps intÃ©grÃ©
	@echo "$(BLUE)ğŸ” VÃ©rification du GitOps intÃ©grÃ©...$(NC)"
	@oc get application openshift-ai-complete -n openshift-gitops >/dev/null 2>&1 && echo "$(GREEN)âœ… Application ArgoCD principale trouvÃ©e$(NC)" || echo "$(RED)âŒ Application ArgoCD principale non trouvÃ©e$(NC)"
	@oc get namespace triton-demo >/dev/null 2>&1 && echo "$(GREEN)âœ… Namespace triton-demo trouvÃ©$(NC)" || echo "$(YELLOW)âš ï¸  Namespace triton-demo non trouvÃ© (dÃ©ployez d'abord le GitOps)$(NC)"
	@oc get all -n triton-demo --no-headers 2>/dev/null | wc -l | xargs -I {} echo "$(BLUE)ğŸ“Š Ressources dans triton-demo: {}$(NC)" || echo "$(YELLOW)âš ï¸  Aucune ressource dans triton-demo$(NC)"

demo-complete: ## DÃ©mo GitOps complÃ¨te (OBSOLÃˆTE)
	@echo "$(YELLOW)âš ï¸  Cette commande est obsolÃ¨te$(NC)"
	@echo "$(BLUE)Le GitOps est maintenant intÃ©grÃ© dans le GitOps principal$(NC)"
	@echo "$(BLUE)Utilisez: make demo-local pour la dÃ©mo locale$(NC)"

demo: demo-local ## DÃ©mo locale (setup + pipeline + deploy + test) - legacy

demo-local: ## DÃ©mo locale (setup + pipeline + deploy + test)
	@echo "$(BLUE)ğŸ¯ DÃ‰MO LOCALE TRITON INFERENCE$(NC)"
	@echo "$(BLUE)â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•$(NC)"
	$(MAKE) setup
	$(MAKE) run-pipeline
	$(MAKE) deploy-model
	$(MAKE) test
	@echo "$(GREEN)ğŸ‰ DÃ‰MO LOCALE TERMINÃ‰E AVEC SUCCÃˆS!$(NC)"

dev: ## Mode dÃ©veloppement (setup + notebook)
	@echo "$(BLUE)ğŸ‘¨â€ğŸ’» MODE DÃ‰VELOPPEMENT$(NC)"
	$(MAKE) setup
	$(MAKE) run-notebook

# RÃ¨gle par dÃ©faut
.DEFAULT_GOAL := help
