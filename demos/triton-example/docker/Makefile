# Makefile optimisÃ© pour Triton Demo Notebook
# Commandes rapides pour build et dÃ©ploiement

.PHONY: help build build-quick deploy test clean gitops-deploy gitops-status

help: ## Afficher l'aide
	@echo "ğŸš€ Commandes disponibles:"
	@echo "  make build        - Build complet de l'image"
	@echo "  make build-quick  - Build rapide avec cache"
	@echo "  make deploy       - DÃ©ploiement du workbench"
	@echo "  make test         - Test de connexion"
	@echo "  make clean        - Nettoyage des images"
	@echo "  make all          - Build + Deploy + Test"
	@echo ""
	@echo "ğŸ”„ Commandes GitOps:"
	@echo "  make gitops-deploy - DÃ©ploiement via GitOps"
	@echo "  make gitops-status - Statut GitOps et ArgoCD"

build: ## Build complet de l'image
	@echo "ğŸ”¨ Build complet..."
	podman build --tag=quay.io/mouachan/triton-demo-notebook:latest --file=Containerfile .
	podman push quay.io/mouachan/triton-demo-notebook:latest

build-quick: ## Build rapide avec cache
	@echo "âš¡ Build rapide..."
	./build-optimized.sh

deploy: ## DÃ©ploiement du workbench
	@echo "ğŸš€ DÃ©ploiement..."
	./deploy-quick.sh

test: ## Test de connexion
	@echo "ğŸ§ª Test de connexion..."
	oc get pods -n triton-demo -l app=triton-workbench
	@echo "ğŸ“Š Statut du workbench:"
	oc get route -n triton-demo | grep triton-workbench || echo "âš ï¸ Route non trouvÃ©e"

clean: ## Nettoyage des images
	@echo "ğŸ§¹ Nettoyage..."
	podman rmi quay.io/mouachan/triton-demo-notebook:latest || true
	podman image prune -f

all: build-quick deploy test ## Tout faire: Build + Deploy + Test
	@echo "ğŸ‰ OpÃ©ration complÃ¨te terminÃ©e!"

# Commandes GitOps
gitops-deploy: ## DÃ©ploiement via GitOps
	@echo "ğŸ”„ DÃ©ploiement GitOps..."
	cd ../../.. && ./scripts/deploy-triton-demo-gitops.sh

gitops-status: ## Statut GitOps et ArgoCD
	@echo "ğŸ” VÃ©rification du statut GitOps..."
	cd ../../.. && ./scripts/check-gitops-status.sh

# Commandes de dÃ©veloppement rapide
dev-build: ## Build de dÃ©veloppement (sans push)
	@echo "ğŸ”¨ Build de dÃ©veloppement..."
	podman build --tag=triton-demo-notebook:dev --file=Containerfile .

dev-test: ## Test local de l'image
	@echo "ğŸ§ª Test local..."
	podman run --rm triton-demo-notebook:dev python -c "import jupyter, jupyterlab, elyra, numpy, pandas, sklearn, matplotlib, kfp; print('âœ… OK')"

# Commandes de diagnostic
status: ## Statut du cluster
	@echo "ğŸ“Š Statut du cluster:"
	oc get pods -n triton-demo
	oc get routes -n triton-demo

logs: ## Logs du workbench
	@echo "ğŸ“ Logs du workbench:"
	oc logs -n triton-demo -l app=triton-workbench --tail=50 -c triton-workbench
